<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
    <link rel="stylesheet" type="text/css" media="screen and (min-width: 900px)" href="mac.css">
    <link rel="stylesheet" type="text/css" media="screen and (max-width: 900px)" href="phone.css">
    <script type="text/javascript" src="camera.js"></script>
    <script type="text/javascript" src="calculations.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase.js"></script>
    <script>
        var config = {
            apiKey: "AIzaSyCbUoec8Hr-DtnUk1srWlpRpGEZycTgBHI",
            authDomain: "arworldgt.firebaseapp.com",
            databaseURL: "https://arworldgt.firebaseio.com",
            projectId: "arworldgt",
            storageBucket: "",
            messagingSenderId: "1007753558225"
        };
        firebase.initializeApp(config);
        // Get a reference to the database service
        var database = firebase.database();

        const username = localStorage.getItem("username");
        const password = localStorage.getItem("password");
        console.log(username);
        console.log(password);
        // Initialize Firebase

        function toDatabase() {
            location.assign('database.html');
        }
        //Storing Position i.e. starting AR world
        var stored;
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(storePosition);
            } else {
                demo.innerHTML = "Geolocation is not supported by this browser.";
            }
        }
        var currHeading;
        function storePosition(position) {
            currLat = 33.774577;//position.coords.latitude;
            currLon = -84.397340;//position.coords.longitude;
            currAlt = 286;//position.coords.altitude;
            if (currLat == null || currLon == null || currAlt == null) {
                demo.innerHTML = "Lat, Lon, or Alt isn't storing";
            }
            //if (position.coords.heading != null) {
            //    currHeading = position.coords.heading;
            //} else {
            currHeading = 0; //calculateHeading();
            cam.setAttribute('position', {
                x: 0,
                y: currAlt,
                z: 0
            });
            //}
            //updatePosition();
            //setInterval(updatePosition, 5000);
        }


        //Updating the Position - Occurs every 5 seconds and only updates if you move more than 7 meters
        function updatePosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(updatePositionHelper);
            } else {
                demo.innerHTML = "Geolocation cannot be updated.";
            }
        }
        function updatePositionHelper(position) {
            let tempLat = position.coords.latitude;
            let tempLon = position.coords.longitude;
            let tempAlt = position.coords.altitude;
            let changeInXDistance = calculateDistance(tempLat, currLat, tempLon, currLon);
            let changeInTotalDistance = Math.sqrt(Math.pow(changeInXDistance, 2) + Math.pow((tempAlt - currAlt), 2));
            if ((Math.pow(changeInTotalDistance, .5) > 5)) {
                currLat = tempLat;
                currLon = tempLon;
                currAlt = tempAlt;
                let changeInBearing = calculateBearing(tempLat, currLat, tempLon, currLon);
                currX = currX + changeInXDistance * Math.sin(toRadians(changeInBearing));
                currZ = currZ + changeInXDistance * -1 * Math.cos(toRadians(changeInBearing));
                cam.setAttribute('position', {
                    x: currX,
                    y: currAlt,
                    z: currZ
                });
            }
        }

        function placeObjs() {
            var objects = firebase.database().ref('objects');
            objects.once('value').then(function (snapshot) {
                snapshot.forEach(function (childSnapshot) {
                    let objectName = childSnapshot.key;
                    let object = `${childSnapshot.key}`;
                    if (snapshot.child(object + '/public').val()) {
                        let latitude = snapshot.child(object + '/latitude').val();
                        let longitude = snapshot.child(object + '/longitude').val();
                        let altitude = snapshot.child(object + '/altitude').val();
                        let color = snapshot.child(object + '/color').val();
                        createObject(latitude, longitude, altitude, color, false);
                    }
                });
            });
        }
    </script>
</head>


<body>

<button onclick="updatePosition()">Update Position</button>
<button onclick="toDatabase()">Settings</button>


<div class="camera">
    <video  id="videoElement"></video>
</div>
<div id="a-scene">
    <a-scene background="color: black; transparent: true" vr-mode-ui="enabled: false">
        <a-assets>
            <a-asset-item id="einstein" src="Einstein.glb"></a-asset-item>
        </a-assets>
        <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#93648D"></a-plane>
        <a-entity id="camera" camera look-controls position="0 1.6 0"></a-entity>
        <a-sphere id="moving" radius="2.5" position="0 10 0" color="white"></a-sphere>
    </a-scene>
</div>
<p id="demo"></p>
<script>
    var cam = document.getElementById("camera");
    getLocation();
    placeObjs();






    const einstein2 = new AR(33.77509, -84.39786, 283, "Actual Ein", 'white', true, 'Einstein.glb');
    const einstein = new AR(33.774577, -84.397340, 295 , "ein", 'white', true, 'Einstein.glb');


    const demo = document.getElementById("demo");


    var currLat;
    var currLon;
    var currAlt;
    var currHeading = 0;
    var currX;
    var currZ;
    var objectsPlaced = false;
    var time = 0;






    //Places Objects in AR

    function createObject(objLatitude, objLongitude, objAltitude, objColor, objGltf) {

        let distance = calculateDistance(currLat, objLatitude, currLon, objLongitude);
        if (distance < 125) {
            let bearing = currHeading + calculateBearing(currLat, objLatitude, currLon, objLongitude);
            demo.innerHTML = "<br>Bearing: " + currHeading;
            let x = distance * Math.sin(toRadians(bearing));
            let y = objAltitude;
            let z = distance * -1 * Math.cos(toRadians(bearing));
            let el = document.createElement('a-entity');
            if (objGltf) {
                el.setAttribute('gltf-model', `${objGltf}`);
                //el.object3D.scale.set(.1, .1, .1);
            } else {
                el.setAttribute('geometry', {
                    primitive: 'sphere',
                    radius: 2.5,
                });
                el.setAttribute('material', {
                    color: objColor
                });
            }
            el.setAttribute('position', {
                x: x,
                y: y,
                z: z
            });
            let sceneEl = document.querySelector('a-scene');
            sceneEl.appendChild(el);
        }
    }







    //Collection of functions used in determining position of the user.

    //Sets current heading as the difference between North and user heading.
    function calculateHeading() {
        if (window.DeviceOrientationEvent) {
            window.addEventListener("deviceorientation", function (event) {
                if(event.webkitCompassHeading) {
                    var compass = event.webkitCompassHeading;
                    handleOrientationEvent(compass);
                } else if (event.absolute == true) {
                    var compass = event.alpha;
                    demo.innerHTML = "<br> Heading: " + compass;
                    handleOrientationEvent(compass);
                } else {
                    demo.innerHTML = "<br>Compass Heading Not Working";
                }
            }, true);
        } else {
            demo.innerHTML = "<br>Compass Heading Not Working";
        }
    }
    function handleOrientationEvent(compass) {
        currHeading = compass;
    }
    //Calculates the distance between user's location and object's location in 2D.


    //AR Object Constructors
    function AR(lat, lon, alt) {
        AR(lat, lon, alt, '');
    }
    function AR(lat, lon, alt, name) {
        AR(lat, lon, alt, '' + name, 'white');
    }
    function AR(lat, lon, alt, name, color, gltf, gltfPath) {
        this.lat = lat;
        this.lon = lon;
        this.alt = alt;
        this.name = name;
        this.color = color;
        this.gltf = gltf;
        this.gltfPath = gltfPath;
    }


    /*
    let objects = firebase.database().ref('/objects/');
    objects.once('value').then(function (snapshot) {
        snapshot.forEach(function (childSnapshot) {
            let objLatitude = snapshot.child(`${childSnapshot.key}/latitude`).val();
            let objLongitude = snapshot.child(`${childSnapshot.key}/longitude`).val();
            let objAltitude = snapshot.child(`${childSnapshot.key}/altitude`).val();
            let objPrivacy = snapshot.child(`${childSnapshot.key}/public`).val();
            let objUsername = snapshot.child(`${childSnapshot.key}/username`).val();
            if (objPrivacy === false) {
                let creatorGroups = firebase.database().ref('/groups/');
                creatorGroups.once('value').then(function (child2Snapshot) {
                    child2Snapshot.forEach(function (child3Snapshot) {
                        let groupnames = child3Snapshot.key;
                        let temp = `/groups/${groupnames}/members`;
                        let members = firebase.database().ref(temp);
                        members.once('value').then(function (child4Snapshot) {
                            let memberNames = child4Snapshot.key;
                            child4Snapshot.forEach(function (child5Snapshot) {
                                let person = child5Snapshot.val();
                                if (person === username) {
                                    createObject(objLatitude, objLongitude, objAltitude);
                                }
                            });
                        });
                    });
                });
            } else {
            }
        });
    });
    */
</script>
</body>
</html>