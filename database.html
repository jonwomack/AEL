<!DOCTYPE html>
<head>
    <script src="https://code.jquery.com/jquery-1.11.3.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase.js"></script>
    <script type="text/javascript" src="firebase.js"></script>
</head>
<body>

<form id="form1" method="get">
    Groupname:
    <input type="text" name="groupname" value="Group Name">
    <br>
    <input type="button" onclick="createGroup()" value="Group Name">
    <br>
    Add User:
    <input type="text" name="addUser" value="User Name">
    <br>
    <input type="button" onclick="addUserToGroup()" value="Add User to Group">
</form>
<br>

<p>Share Location:
    <label class="switch">
        <input class="switch-input" type="checkbox" />
        <span class="switch-label" data-on="Yes" data-off="No"></span>
        <span class="switch-handle"></span>
    </label>
</p>

<br>


<form id="form2" method="get">
    Object Name:
    <input type="text" name="objectname" value="Name">
    <br>
    Latitude:
    <input type="text" name="lat" value="33.774577">
    <br>
    Longitude:
    <input type="text" name="lon" value="-84.397340">
    <br>
    Altitude (Meters):
    <input type="text" name="alt" value="286">
    <br>
    Color:
    <input type="text" name="color" value="black">
    <br>
    Public:
    <label class="switch2">
        <input class="switch-input2" type="checkbox" />
        <span class="switch-label2" data-on="Yes" data-off="No"></span>
        <span class="switch-handle2"></span>
    </label>
    <br>
    <script>
        var bool2 = false;
        var myVar3;
        var myVar4;
        (function() {
            $(document).ready(function() {
                $('.switch-input2').on('change', function() {
                    var isChecked = $(this).is(':checked');
                    if (isChecked) {
                        clearInterval();
                        bool2 = true;
                        myVar3 = setInterval(addUserLocation, 1000);
                    } else {
                        clearInterval();
                        bool2 = false;
                        myVar4 = setInterval(addUserLocation, 1000);
                    }
                });
            });
        })();
    </script>
    <input type="button" onclick="writeObjectData2(bool2)" value="Create Object">
    <br>
</form>





<button onclick="goBack()">Back</button>

<p id="demo"></p>


<script>
    function addUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(addUserLocationH);
        } else {
            demo.innerHTML = "Geolocation is not supported by this browser.";
        }
    }
    function addUserLocationH(position) {
        currLat = position.coords.latitude;
        currLon = position.coords.longitude;
        currAlt = 0//position.coords.altitude;
        if (currLat == null || currLon == null || currAlt == null) {
            currLat = 0;
            currLon = 0;
            currAlt = 0;
            //alert("no geo");
        } else {
            if (bool) {
                let user = firebase.database().ref(`/users/${username}`);
                user.update({
                    location: true
                });
                writeObjectData(username, currLat, currLon, currAlt, username, true, 'black');
            } else {
                let user = firebase.database().ref(`/users/${username}`);
                user.update({
                    location: true
                });
                writeObjectData(username, currLat, currLon, currAlt, username, false, 'black');
            }
        }
    }
    async function objExists(name) {
        let promise = new Promise(resolve => {
            let object = false;
            let objects = firebase.database().ref(`objects`);
            objects.once('value').then(function (snapshot) {
                snapshot.forEach(function (childSnapshot){
                    let objectName = childSnapshot.key;
                    if (name === objectName) {
                        object = true;
                    }
                });
            });
            setTimeout(() => resolve(object), 500);
        });
        let value = await promise;
        return value;
    }
    async function writeObjectData2(bool2) {
        let x = document.getElementById("form2");
        let name = x.elements[0].value;
        let lat = x.elements[1].value;
        let lon = x.elements[2].value;
        let alt = x.elements[3].value;
        let color = x.elements[4].value;
        let exists = await objExists(name);
        if (!exists) {
            writeObjectData(name, lat, lon, alt, username, bool2, color);
        } else {
            alert("Object Already Exists");
        }
    }

    function writeObjectData(name, latitude, longitude, altitude, username, pub, color) {
        firebase.database().ref('/objects/' + name).set({
            longitude: longitude,
            latitude: latitude,
            altitude: altitude,
            username: username,
            public: pub,
            color: color
        });
    }

    var bool = false;
    var myVar;
    var myVar2;
    (function() {
        $(document).ready(function() {
            $('.switch-input').on('change', function() {
                var isChecked = $(this).is(':checked');
                if (isChecked) {
                    clearInterval();
                    bool = true;
                    myVar = setInterval(addUserLocation, 1000);
                } else {
                    clearInterval();
                    bool = false;
                    myVar2 = setInterval(addUserLocation, 1000);
                }
            });
        });

    })();

    const username = localStorage.getItem("username");
    const password = localStorage.getItem("password");
    function createGroup() {
        let x = document.getElementById("form1");
        let groupname = x.elements[0].value;
        let path = `/groups/${groupname}/`;
        let groups = firebase.database().ref('/groups/');
        let exists = false;
        groups.once('value').then(function (snapshot) {
            snapshot.forEach(function (childSnapshot) {
                let groupsDB = childSnapshot.key;
                if (groupsDB === groupname) {
                    exists = true;
                }
            });
            if (!exists) {
                firebase.database().ref(path).set({
                    groupsize: 1
                });
                let newMemberRef = firebase.database().ref(path + 'members/');
                newMemberRef.update({
                    [username]: 0
                });
            } else {
                demo.innerHTML = "Group Already Exists";
            }
        });
    }

    function goBack() {
        location.assign('arworld.html');
    }
    async function inGroup(groupsize, userToAdd, pathToGroup, groupname) {
        let result = await inGroupH(groupsize, userToAdd, pathToGroup, groupname);
        return result;
    }
    async function inGroupH(groupsize, userToAdd, pathToGroup, groupname) {
        let promise = new Promise(resolve => {
            let member = false;
            let usersInGroup = firebase.database().ref(`/groups/${groupname}/members/`);
            usersInGroup.once('value').then(function (snapshot) {
                snapshot.forEach(function (childSnapshot){
                    let userInGroup = childSnapshot.key;
                    if (userToAdd === userInGroup) {
                        console.log("useringroup");
                        member = true;
                    }
                });
            });
            setTimeout(() => resolve(member), 500);
        });
        let value = await promise;
        return value;
    }
    async function userExists(userToAdd) {
        let result = await userExistsH(userToAdd);
        return result;
    }
    async function userExistsH(userToAdd) {
        let promise = new Promise(resolve => {
            let exists = false;
            let users = firebase.database().ref('/users/');
            users.once('value').then(function (snapshot) {
                snapshot.forEach(function (childSnapshot) {
                    let usernameDB = childSnapshot.key;
                    if (usernameDB === userToAdd) {
                        exists = true;
                        console.log("userexists");
                    }
                });
            });
            setTimeout(() => resolve(exists), 500);
        });
        let value = await promise;
        return value;
    }

    async function groupExists(groupname) {
        let result = await groupExistsH(groupname);
        return result;
        // expected output: 'resolved'
        /*result = await callback(groupname);
        console.log(result);
        return result;
        */
    }
    async function groupExistsH(groupname) {
        let promise = new Promise(resolve => {
            let exists = false;
            let groups = firebase.database().ref('/groups/');
            groups.once('value').then(function (snapshot) {
                snapshot.forEach(function (childSnapshot) {
                    let groupnameDB = childSnapshot.key;
                    if (groupnameDB === groupname) {
                        exists = true;
                        console.log("group exists");
                    }
                });
            });
            setTimeout(() => resolve(exists), 500); // resolve
        });

        // wait for the promise to resolve
        let value = await promise;
        return value;
    }


    async function addUserToGroup() {
        var x = document.getElementById("form1");
        let groupname = x.elements[0].value;
        let userToAdd = x.elements[2].value;
        let pathToGroup = `/groups/${groupname}/`;
        let groupsize = 0;
        let result = await groupExists(groupname, groupExistsH());
        let result2 = await userExists(userToAdd);
        firebase.database().ref(pathToGroup + '/groupsize/').once('value').then(function (snapshot) {
            groupsize = snapshot.val();
        });
        let result3 = await inGroup(groupsize, userToAdd, pathToGroup, groupname);

        if (!result3) {
            if (result2) {
                if (result) {
                    console.log("accessed");
                    firebase.database().ref(pathToGroup).update({
                        groupsize: groupsize + 1
                    });
                    let newMemberRef = firebase.database().ref(pathToGroup + 'members/');
                    newMemberRef.update({
                        [userToAdd]: groupsize
                    });
                }
            }
        }
    }







</script>
</body>
</html>