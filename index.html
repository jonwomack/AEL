<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
    <style>
        a-scene {
            position: relative;
            left: 33%;
            width: 600px;
            height: 400px;
        }
        #a-scene {
            margin-left: 10 auto;
            margin-right: 10 auto;
            display: block;
        }
        #container {
            position: absolute;
            left: 550px;
        }
        p {
            position: relative;
            text-align: center;
            color: white;
        }
        button {
            position: relative;
            left: 50%;
        }
        body {
            background-color: #00BFFF;
        }
    </style>
</head>
<body>
<div id="flip-button">
    <button onclick="">Flip Camera</button>
</div>
<p>First, store your lat/lon by pressing this button.</p>
<button onclick="getLocation()">Store</button>
<p>Update position using this button.</p>
<button onclick="updatePosition()">Update</button>
<p>Then, place objects by pressing this button</p>
<button onclick="placeObjects()">Place</button>

<div id="container">
    <video  id="videoElement">
    </video>
</div>

<!--<div id="a-scene">
    <a-scene embedded background="color: black; transparent: true">
        <a-assets>
            <a-asset-item id="buzz" src="Buzz_Solid.gltf"></a-asset-item>
            <a-asset-item id="bin" src="Buzz_Solid.bin"></a-asset-item>
            <a-asset-item id="einstein" src="Einstein.glb"></a-asset-item>
        </a-assets>
        <a-sky material="src: #webcam"></a-sky>
        <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#93648D"></a-plane>
        <a-entity id="camera" camera look-controls position="0 1.6 0"></a-entity>
        <a-sphere radius="5" position="0 10 0" color="white"></a-sphere>
        <a-entity gltf-model="#einstein" position="0 1.6 -10" rotation="0 -90 0" scale="1 1 2"></a-entity>
    </a-scene>
</div>-->

<p>To see current position click here</p>
<button onclick="makeString()">Here</button>
<p>List Objects</p>
<button onclick="ARtoString()">List</button>
<p id="demo"></p>
<script>
    const waffleHouse = new AR(33.776607,-84.389426, "Waffle House");
    const starBucks = new AR(33.776527, -84.388348, "Starbucks");
    const ncr = new AR(33.779051, -84.389330, "NCR Global");
    const westVillage = new AR(33.779457, -84.404843, "West Village", 'black');
    const wingZone = new AR(33.779466, -84.405400, "Wing Zone", 'black');
    const fitten = new AR(33.778210, -84.403753, "Fitten", 'black');
    const folk = new AR(33.778907, -84.404858, "Folk", 'black');
    const caldwell = new AR(33.778897, -84.404419, "Caldwell", 'black');
    const fulmer = new AR(33.778625, -84.403892, "Fulmer", 'black');
    const westVillageDiningCommons = new AR(33.779146, -84.404474, "WVDC", 'black');
    const eighth = new AR(33.779803, -84.403961, "Due North", 'black');
    const coor = new AR(33.779125, -84.403064, "East Point", 'black');
    const einstein = new AR(33.775203, -84.397774,  "einstein", '')
    const objs = [waffleHouse, starBucks, ncr
        , westVillage, wingZone, fitten, folk, caldwell, fulmer
        , westVillageDiningCommons, eighth, coor];
    const demo = document.getElementById("demo");
    var currLat;
    var currLon;
    var currAlt;
    var currHeading;
    var currX = 0;
    var currZ = 0;


    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(storePosition);
        } else {
            demo.innerHTML = "Geolocation is not supported by this browser.";
        }
    }
    function updatePosition() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(updatePositionHelper);
        } else {
            demo.innerHTML = "Geolocation cannot be updated.";
        }
    }
    function updatePositionHelper(position) {
        let cam = document.getElementById("camera");
        let tempLat = position.coords.latitude;
        let tempLon = position.coords.longitude;
        let changeInDistance = calculateDistance(tempLat, currLat, tempLon, currLon);
        let changeInBearing = calculateBearing(tempLat, currLat, tempLon, currLon);
        if (changeInDistance > 10) {
            currLat = position.coords.latitude;
            currLon = position.coords.longitude;
            currX = currX + changeInDistance * Math.cos(toRadians(changeInBearing));
            currZ = currZ + changeInDistance * Math.sin(toRadians(changeInBearing))
            cam.setAttribute('position', {
                x: currX,
                y: 1.6,
                z: currZ
            });
        }
    }



    function storePosition(position) {
        //currLat = position.coords.latitude;
        //currLon = position.coords.longitude;
        currLat = 33.779149;
        currLon = -84.403955;
        //currAlt = position.coords.altitude;
        //currHeading = position.coords.heading;
    }

    function placeObjects() {
        objs.forEach(function (item, index, array) {
            createObject(item);
        });
    }


    function createObject(obj) {
        demo.innerHTML += "<br>Name: " + obj.name + " ";
        let distance = calculateDistance(currLat, obj.lat, currLon, obj.lon);
        let bearing = calculateBearing(currLat, obj.lat, currLon, obj.lon);
        let x = distance * Math.cos(toRadians(bearing));
        let y = 10;
        let z = distance * Math.sin(toRadians(bearing));
        let el = document.createElement('a-entity');
        el.setAttribute('geometry', {
            primitive: 'sphere',
            radius: 5,
        });
        el.setAttribute('material', {
            color: obj.color
        });
        el.setAttribute('position', {
            x: x,
            y: y,
            z: z
        });
        let sceneEl = document.querySelector('a-scene');
        el.flushToDOM();
        sceneEl.appendChild(el);
    }

    function makeString() {
        demo.innerHTML = "Latitude: " + currLat +
            "<br>Longitude: " + currLon +
            "<br>Altitude: " + currAlt +
            "<br>Heading: " + currHeading + "<br><br>";
    }

    function calculateDistance(lat1, lat2, lon1, lon2) {
        const radius = 6371e3; // Radius of Earth in Meters
        let lat1radians = toRadians(lat1);
        let lat2radians = toRadians(lat2);
        let deltaLat = toRadians(lat2-lat1);
        let deltaLon = toRadians(lon2-lon1);
        let a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) + Math.cos(lat1radians) * Math.cos(lat2radians) * Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
        let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        let distance = radius * c;
        demo.innerHTML += "<br>Distance: " + distance;
        return distance;
    }

    function calculateBearing(latB1, latB2, lonB1, lonB2) {
        let dLon = (lonB2-lonB1);
        let y = Math.sin(dLon) * Math.cos(latB2);
        let x = Math.cos(latB1)*Math.sin(latB2) - Math.sin(latB1)*Math.cos(latB2)*Math.cos(dLon);
        let brng = toDegrees((Math.atan2(y, x)));
        brng = (360 - ((brng + 360) % 360));
        demo.innerHTML += "<br>Bearing: " + brng + "<br>";
        return brng;
    }

    function toDegrees(radians) {
        return radians * (180/Math.PI);
    }
    function toRadians(degrees) {
        return degrees * (Math.PI/180);
    }
    function AR(lat, lon) {
        AR(lat, lon, '');
    }
    function AR(lat, lon, name) {
        AR(lat, lon, '' + name, 'white');
    }

    function AR(lat, lon, name, color) {
        this.lat = lat;
        this.lon = lon;
        this.name = name;
        this.color = color;
    }

    function ARtoString() {
        objs.forEach(function (item, index, array) {
            demo.innerHTML += "<br>Name: " + item.name +
                "<br>Latitude: " + item.lat +
                "<br>Longitude: " + item.lon + "<br><br>";
        })
    }
</script>
<script>
    var front = false;
    document.getElementById('flip-button').onclick = function() {
        front = !front;
        console.log("Switched Camera")
    };
    var constraints = { video: { facingMode: (front? "user" : "environment") } };
    navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
            var video = document.querySelector('video');
            if ("srcObject" in video) {
                video.srcObject = stream;
            } else {
                video.src = window.URL.createObjectURL(stream);
            }
            video.onloadedmetadata = function(e) {
                video.play();
            };
        })
        .catch(function(err) {
            console.log(err.name + ": " + err.message);
        });
</script>





</body>
</html>