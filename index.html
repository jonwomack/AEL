<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
    <link rel="stylesheet" type="text/css" media="screen and (min-width: 900px)" href="mac.css">
    <link rel="stylesheet" type="text/css" media="screen and (max-width: 900px)" href="phone.css">
</head>
<body>
<p>First, store your lat/lon by pressing this button.</p>
<button onclick="getLocation()">Store</button>
<p>West Campus Objects</p>
<button onclick="placeObjects(westObjs)">Place</button>
<p>Dr.Freeman Objects</p>
<button onclick="placeObjects(freeman)">Place</button>
<button onclick="moveObject()">Move</button>
<div class="camera">
    <video  id="videoElement"></video>
</div>

<div id="a-scene">
    <a-scene background="color: black; transparent: true" vr-mode-ui="enabled: false">
        <a-assets>
            <a-asset-item id="buzz" src="Buzz_Solid.gltf"></a-asset-item>
            <a-asset-item id="bin" src="Buzz_Solid.bin"></a-asset-item>
            <a-asset-item id="einstein" src="Einstein.glb"></a-asset-item>
        </a-assets>
        <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#93648D"></a-plane>
        <a-entity id="camera" camera look-controls position="0 1.6 0"></a-entity>
        <a-sphere id="moving" radius="5" position="0 10 0" color="white"></a-sphere>
        <a-entity gltf-model="#einstein" position="0 1.6 -10" rotation="0 -90 0" scale="1 1 2"></a-entity>
    </a-scene>
</div>
<p id="demo"></p>

<script>


    const north = new AR(33.953149972982295, -84.6382802709262, 304, "North", 'red');
    const south = new AR(33.95212652307029, -84.63830172859832, 304, "South", 'blue');
    const east = new AR(33.95263379978259, -84.6376687272708, 304, "East", 'yellow');
    const west = new AR(33.952656048692, -84.63894009434387, 304, "West", 'purple');
    const given = new AR(33.95262935, -84.63824272, 304, "Given", 'white');

    const ym = new AR(33.776998,-84.389803, 292, "Yogli Mogli", 'blue');

    const freeman = [north, south, east, west, given];

    const westObjs = [ym];
    const demo = document.getElementById("demo");
    const el = document.getElementById("moving");

    var currLat;
    var currLon;
    var currAlt;
    var currHeading;
    var currX;
    var currZ;
    var objectsPlaced = false;
    var time = 0;


    //Moving Object
    function moveObject() {
        setInterval(moveObjectH, 20);
    }
    function moveObjectH() {
        let x = currX + 100*Math.cos(time);
        let y = currAlt;
        let z = currZ + 100*Math.sin(time);
        el.object3D.position.set(x, y, z);
        time += (5*Math.PI)/360;
    }


    //Storing Position i.e. starting AR world
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(storePosition);
        } else {
            demo.innerHTML = "Geolocation is not supported by this browser.";
        }
    }
    function storePosition(position) {
        currLat = position.coords.latitude;
        currLon = position.coords.longitude;
        currAlt = position.coords.altitude;
        if (currLat == null || currLon == null || currAlt == null) {
            demo.innerHTML = "Lat, Lon, or Alt isn't storing";
        }
        //if (position.coords.heading != null) {
        //    currHeading = position.coords.heading;
        //} else {
        calculateHeading();
        //}

        setInterval(updatePosition, 5000);
    }


    //Updating the Position - Occurs every 5 seconds and only updates if you move more than 10 meters
    function updatePosition() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(updatePositionHelper);
        } else {
            demo.innerHTML = "Geolocation cannot be updated.";
        }
    }
    function updatePositionHelper(position) {
        let cam = document.getElementById("camera");
        let tempLat = position.coords.latitude;
        let tempLon = position.coords.longitude;
        let tempAlt = position.coords.longitude;
        let changeInDistance = calculateDistance(tempLat, currLat, tempLon, currLon, tempAlt, currAlt);
        let changeInBearing = calculateBearing(tempLat, currLat, tempLon, currLon);
        if (changeInDistance > 10) {
            demo.innerHTML = "Altitude: " + position.coords.altitude;
            currLat = position.coords.latitude;
            currLon = position.coords.longitude;
            currAlt = position.coords.altitude;
            currX = currX + changeInDistance * Math.cos(toRadians(changeInBearing));
            currZ = currZ + changeInDistance * Math.sin(toRadians(changeInBearing));
            cam.setAttribute('position', {
                x: currX,
                y: currAlt,
                z: currZ
            });
        }
    }


    //Places Objects in AR
    function placeObjects(array) {
        if (!objectsPlaced) {
            var counter = 0;
            while (counter < 5) {
                updatePosition();
                counter++;
            }
            array.forEach(function (item, index, array) {
                createObject(item);
            });
            objectsPlaced = true;
        }
    }
    function createObject(obj) {
        let distance = calculateDistance(currLat, obj.lat, currLon, obj.lon, currAlt, obj.alt);
        let bearing = currHeading + calculateBearing(currLat, obj.lat, currLon, obj.lon);
        let x = distance * Math.cos(toRadians(bearing));
        let y = obj.alt;
        let z = distance * Math.sin(toRadians(bearing));
        let el = document.createElement('a-entity');
        el.setAttribute('geometry', {
            primitive: 'sphere',
            radius: 5,
        });
        el.setAttribute('material', {
            color: obj.color
        });
        el.setAttribute('position', {
            x: x,
            y: y,
            z: z
        });
        let sceneEl = document.querySelector('a-scene');
        sceneEl.appendChild(el);
    }






//Collection of functions used in determining position of the user.

    //Sets current heading as the difference between North and user heading.
    function calculateHeading() {
        if (window.DeviceOrientationEvent) {
            window.addEventListener("deviceorientation", function (event) {
                if(event.webkitCompassHeading) {
                    // Apple works only with this, alpha doesn't work
                    var compass = event.webkitCompassHeading;
                    handleOrientationEvent(compass);
                } else {
                    demo.innerHTML = "Compass Heading Not Working";
                }
            }, true);
        } else {
            demo.innerHTML = "Compass Heading Not Working";
        }
    }
    function handleOrientationEvent(compass) {
        currHeading = compass;
    }
    //Calculates the distance between user's location and object's location.
    function calculateDistance(lat1, lat2, lon1, lon2, alt1, alt2) {
        const radius = 6371e3; // Radius of Earth in Meters
        let lat1radians = toRadians(lat1);
        let lat2radians = toRadians(lat2);
        let deltaLat = toRadians(lat2-lat1);
        let deltaLon = toRadians(lon2-lon1);
        let a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) + Math.cos(lat1radians) * Math.cos(lat2radians) * Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
        let c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        let latlondistance = radius * c;
        let altDistance = alt1 - alt2;
        return Math.pow((Math.pow(latlondistance, 2) + Math.pow(altDistance, 2)), .5);
    }
    //Calculates angle between user's location and object's location
    function calculateBearing(latB1, latB2, lonB1, lonB2) {
        let dLon = (lonB2-lonB1);
        let y = Math.sin(dLon) * Math.cos(latB2);
        let x = Math.cos(latB1)*Math.sin(latB2) - Math.sin(latB1)*Math.cos(latB2)*Math.cos(dLon);
        let brng = toDegrees((Math.atan2(y, x)));
        brng = (360 - ((brng + 360) % 360));
        return brng;
    }





    //Math functions
    function toDegrees(radians) {
        return radians * (180/Math.PI);
    }
    function toRadians(degrees) {
        return degrees * (Math.PI/180);
    }





    //AR Object Constructors
    function AR(lat, lon, alt) {
        AR(lat, lon, alt, '');
    }
    function AR(lat, lon, alt, name) {
        AR(lat, lon, alt, '' + name, 'white');
    }
    function AR(lat, lon, alt, name, color) {
        this.lat = lat;
        this.lon = lon;
        this.alt = alt;
        this.name = name;
        this.color = color;
    }
</script>
<script>
    //Enables camera functionality
    var front = false;
    var constraints = { video: { facingMode: (front? "user" : "environment") } };
    navigator.mediaDevices.getUserMedia(constraints)
        .then(function success(stream) {
            var video = document.querySelector('video');
            if ("srcObject" in video) {
                video.srcObject = stream;
            } //else {
                //video.src = window.URL.createObjectURL(stream);
            //}
            video.setAttribute('autoplay', '');
            video.setAttribute('muted', '');
            video.setAttribute('playsinline', '');
            video.onloadedmetadata = function(e) {
                video.play();
            };
        })
        .catch(function(err) {
            console.log(err.name + ": " + err.message);
            demo.innerHTML = "<br> Line 237 of code not entered";
        });

</script>
</body>
</html>